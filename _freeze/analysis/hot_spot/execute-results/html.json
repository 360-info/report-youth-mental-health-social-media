{
  "hash": "8ac206399fa8600b77c67da4b0523acc",
  "result": {
    "markdown": "---\ntitle: Hot Spot Analysis of Mental Health Proportions\nsubtitle: Utilising mental health prevalance in 15-24 year olds at ABS SA2 level\nformat:\n  360-analysis-html: default\nauthor: Dean Marchiori\ndate: last-modified\ncode-fold: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.2     ✔ readr     2.1.4\n✔ forcats   1.0.0     ✔ stringr   1.5.0\n✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n✔ purrr     1.0.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE\n```\n:::\n\n```{.r .cell-code}\nlibrary(sfdep)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nThe legacy packages maptools, rgdal, and rgeos, underpinning the sp package,\nwhich was just loaded, will retire in October 2023.\nPlease refer to R-spatial evolution reports for details, especially\nhttps://r-spatial.org/r/2023/05/15/evolution4.html.\nIt may be desirable to make the sf package available;\npackage maintainers should consider adding sf to Suggests:.\nThe sp package is now running under evolution status 2\n     (status 2 uses the sf package in place of rgdal)\n```\n:::\n\n```{.r .cell-code}\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nhere() starts at /home/wavedatalabs/Documents/wd/report-youth-mental-health-social-media\n```\n:::\n\n```{.r .cell-code}\nlibrary(rmapshaper)\n```\n:::\n\n\n# Data Import \n\nDownload Australia level Geopackage from ABS. For more info see `data/README.md`\n\nNote: This will check if the file exists before downloading as its ~2.1GB zipped.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!file.exists(here(\"data/raw/ABS_Geo_2021.zip\"))) {\n\n    download.file(here(\"https://www.abs.gov.au/census/find-census-data/geopackages/download/Geopackage_2021_G19_AUST_GDA2020.zip\"),\n        destfile = here(\"data/raw/ABS_Geo_2021.zip\"), method = \"curl\"\n    )\n\n    unzip(here(\"data/raw/ABS_Geo_2021.zip\"), exdir = here(\"data/raw/ABS_Geo_2021\"))\n}\n```\n:::\n\n\nThe health tables are covered in table 19 of the geopackage. This is split across three files, A, B & C.\nWe only need files B and C for this analysis.  Combining together.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Extracting SA2 layers \nmh2 <- sf::read_sf(here(\"data/raw/ABS_Geo_2021/G19B_AUST_GDA2020.gpkg\"), layer = \"G19B_SA2_2021_AUST\")\nmh3 <- sf::read_sf(here(\"data/raw/ABS_Geo_2021/G19C_AUST_GDA2020.gpkg\"), layer = \"G19C_SA2_2021_AUST\")\nmh_all <- cbind(mh2, mh3)\n```\n:::\n\n\n## Data Processing \n\nSelecting only the 15-24 year age group, and selecting Persons (not Male/Female).  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmh_dat <- mh_all |>\n    st_drop_geometry() |>\n    as_tibble()  |>\n    select(\n        SA2_CODE_2021,\n        contains(c(\"P_Mental\", \"P_Tot\")),\n        -P_Tot_Tot,\n        -P_Mental_health_cond_Tot\n    ) |>\n    pivot_longer(-c(SA2_CODE_2021),\n        names_to = \"cat\"\n    ) |>\n    separate_wider_regex(cat,\n        patterns = c(cond = \"P_.+\", age = \"(?<=_)[0-9]+_.+$\")\n    ) |> \n    pivot_wider(names_from = cond) |>\n    rename(\n        condition = P_Mental_health_cond_,\n        total = P_Tot_\n    ) |>\n    mutate(\n        prop = condition / total,\n        prop = replace_na(prop, 0)\n    )  |>\n    filter(age == \"15_24\")\n```\n:::\n\n\njoining with spaital objects \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmh_map <- mh_all |>\n    select(SA2_CODE_2021, SA2_NAME_2021, geom) |>\n    inner_join(mh_dat)  |>\n    as_tibble()  |>\n    st_as_sf()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining with `by = join_by(SA2_CODE_2021)`\n```\n:::\n:::\n\n\nComputing neighborhood network and weights. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmh_wts <- mh_map |>\n    filter(\n        !st_is_empty(geom) # removing offshore / shipping / no address\n    ) |>\n    mutate(\n        nb = st_contiguity(geom),\n        wt = st_weights(nb, allow_zero = TRUE) # zero weights can occur from islands that have no neighbours with queen contiguity\n    )\n```\n:::\n\n\nCalculating spatials lags and Local Morans-I \n\n\n::: {.cell}\n\n```{.r .cell-code}\n mh_moran <- mh_wts |>\n    mutate(\n        prop_lag = st_lag(prop, nb, wt, allow_zero = TRUE),\n        local_moran = local_moran(prop, nb, wt, zero.policy = TRUE),\n    ) |>\n    tidyr::unnest(local_moran)\n```\n:::\n\n\nprepare data for export \n\n\n::: {.cell}\n\n```{.r .cell-code}\nhot_spot_data <- mh_moran |>\n    mutate(\n        cluster = ifelse(p_folded_sim <= 0.05, as.character(mean), NA),\n        cluster = as.character(fct_recode(cluster,\n            `Hot Spot` = \"High-High\",\n            `Isolated Hot Spot` = \"High-Low\",\n            `Cold Spot` = \"Low-Low\",\n            `Isolated Cold Spot` = \"Low-High\"\n        )),\n        prop_tooltip = paste0(round(prop * 100, 1), \"%\"),\n        prop_lag_tooltip = paste0(round(prop_lag * 100, 1), \"%\")\n    ) |>\n    filter(\n        ii != 0, # removes polygons with no neighbours i.e. islands\n        !is.na(cluster) # removes polygons with not significant p value for morans I\n    ) |> \n    select(SA2_CODE_2021, SA2_NAME_2021, age, condition, total, prop, prop_lag, cluster, prop_tooltip, prop_lag_tooltip) |>\n    rmapshaper::ms_simplify(keep_shapes = TRUE, keep = 0.10) \n```\n:::\n\n\n\n# Data Export  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (file.exists(here(\"data/final/mental_health_hotspot.geojson\"))) {\n    message(\"Please delete file first as it cannot be overwritten\")\n} else{\nsf::st_write(hot_spot_data, here(\"data/final/mental_health_hotspot.geojson\"), append = FALSE, delete_layer = TRUE)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlease delete file first as it cannot be overwritten\n```\n:::\n:::\n",
    "supporting": [
      "hot_spot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}